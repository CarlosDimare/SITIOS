<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>NewsHub - Lector de Noticias Inteligente</title>

  <!-- Nota: Para un HTML único usamos el CDN. En producción compila Tailwind. -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: { bg: '#0a0a0a', card: '#1a1a1a', border: '#2a2a2a', text: '#ffffff', muted: '#9ca3af' }
          }
        }
      }
    }
  </script>

  <style>
    .news-item { transition: all 0.3s ease; }
    .news-item:hover { transform: translateY(-2px); }
    .source-tab { transition: all 0.2s ease; }
    .source-tab.active { border-bottom: 3px solid #3b82f6; }
    .chat-message { animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .tag-pill { transition: all 0.2s ease; }
    .tag-pill:hover { transform: scale(1.05); }
    .notification { animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .loader { border: 3px solid #f3f3f3; border-top: 3px solid #3b82f6; border-radius: 50%;
      width: 30px; height: 30px; animation: spin 1s linear infinite; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .dark .loader { border: 3px solid #2a2a2a; border-top: 3px solid #3b82f6; }
    body { transition: background-color 0.3s ease, color 0.3s ease; }
    .dark-mode-transition * { transition: background-color .3s ease, color .3s ease, border-color .3s ease; }
    .search-result { transition: all .2s ease; }
    .search-result:hover { background-color: rgba(59,130,246,.05); transform: translateY(-2px);
      box-shadow: 0 4px 6px rgba(0,0,0,.1); }
    .dark .search-result:hover { background-color: rgba(59,130,246,.1); }
    .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 dark:bg-dark-bg dark:text-dark-text dark-mode-transition">

  <!-- Header -->
  <header class="bg-white shadow-md sticky top-0 z-40 dark:bg-dark-card dark:border-b dark:border-dark-border">
    <div class="container mx-auto px-4 py-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-newspaper text-blue-600 dark:text-blue-400 text-2xl"></i>
          <h1 class="text-2xl font-bold text-gray-800 dark:text-dark-text">NewsHub</h1>
        </div>
        <div class="flex items-center space-x-4">
          <button id="addSourceBtn" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
            <i class="fas fa-search mr-2"></i>Buscar Fuente
          </button>
          <button id="refreshAllBtn" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
            <i class="fas fa-sync-alt mr-2"></i>Actualizar Todo
          </button>
          <button id="darkModeToggle" class="p-2 rounded-lg bg-gray-200 dark:bg-dark-card dark:border dark:border-dark-border hover:bg-gray-300 dark:hover:bg-gray-700 transition">
            <i class="fas fa-moon dark:hidden"></i>
            <i class="fas fa-sun hidden dark:inline"></i>
          </button>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <div class="container mx-auto px-4 py-6">
    <div class="flex flex-col lg:flex-row gap-6">

      <!-- Sidebar -->
      <aside class="lg:w-1/4">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 dark:bg-dark-card dark:border dark:border-dark-border">
          <h2 class="text-lg font-semibold mb-3 flex items-center dark:text-dark-text">
            <i class="fas fa-list mr-2 text-blue-600 dark:text-blue-400"></i>
            Fuentes de Noticias
          </h2>
          <div id="sourcesList" class="space-y-2"></div>
          <div id="noSources" class="text-center py-8">
            <i class="fas fa-newspaper text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No hay fuentes agregadas</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Haz clic en "Buscar Fuente" para empezar</p>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 mb-4 dark:bg-dark-card dark:border dark:border-dark-border">
          <h2 class="text-lg font-semibold mb-3 flex items-center dark:text-dark-text">
            <i class="fas fa-tags mr-2 text-blue-600 dark:text-blue-400"></i>
            Palabras Clave
          </h2>
          <div id="tagsContainer" class="flex flex-wrap gap-2 mb-3"></div>
          <div class="flex items-center space-x-2">
            <input id="newTagInput" type="text" placeholder="Nueva palabra clave"
                   class="flex-1 px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text"/>
            <button id="addTagBtn" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
              <i class="fas fa-plus"></i>
            </button>
          </div>
        </div>

        <div class="bg-white rounded-lg shadow-md p-4 dark:bg-dark-card dark:border dark:border-dark-border">
          <h2 class="text-lg font-semibold mb-3 flex items-center dark:text-dark-text">
            <i class="fas fa-filter mr-2 text-blue-600 dark:text-blue-400"></i>
            Filtros
          </h2>
          <div class="space-y-2">
            <button id="filterAllBtn" class="w-full px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-left dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text dark:hover:bg-gray-700">
              <i class="fas fa-globe mr-2"></i>Todas las noticias
            </button>
            <button id="filterUnreadBtn" class="w-full px-3 py-2 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition text-left dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text dark:hover:bg-gray-700">
              <i class="fas fa-envelope mr-2"></i>No leídas
            </button>
          </div>
        </div>
      </aside>

      <!-- Content -->
      <main class="lg:w-3/4">
        <div class="bg-white rounded-lg shadow-md p-4 mb-4 dark:bg-dark-card dark:border dark:border-dark-border">
          <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-semibold flex items-center dark:text-dark-text">
              <i class="fas fa-newspaper mr-2 text-blue-600 dark:text-blue-400"></i>
              <span id="currentViewTitle">Todas las Noticias</span>
            </h2>
            <div class="flex items-center space-x-2">
              <select id="sortBySelect" class="px-3 py-1 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text">
                <option value="date">Más Recientes</option>
                <option value="source">Por Fuente</option>
                <option value="title">Alfabético</option>
              </select>
              <div class="flex items-center space-x-1">
                <button id="viewGridBtn" class="p-2 bg-gray-200 rounded hover:bg-gray-300 transition dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text dark:hover:bg-gray-700">
                  <i class="fas fa-th"></i>
                </button>
                <button id="viewListBtn" class="p-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                  <i class="fas fa-list"></i>
                </button>
              </div>
            </div>
          </div>

          <div id="sourceTabs" class="flex space-x-2 mb-4 overflow-x-auto pb-2"></div>

          <div id="newsContainer" class="space-y-4"></div>

          <div id="loadingIndicator" class="hidden flex justify-center items-center py-8">
            <div class="loader"></div>
          </div>

          <div id="emptyState" class="text-center py-12">
            <i class="fas fa-newspaper text-6xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <h3 class="text-xl font-semibold text-gray-500 dark:text-gray-400 mb-2">No hay noticias para mostrar</h3>
            <p class="text-gray-400 dark:text-gray-500">Agrega fuentes de noticias para comenzar</p>
          </div>
        </div>
      </main>
    </div>
  </div>

  <!-- Search Modal -->
  <div id="searchModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-3xl w-full max-h-[80vh] overflow-hidden flex flex-col dark:bg-dark-card dark:border dark:border-dark-border">
      <div class="p-4 border-b flex items-center justify-between dark:border-dark-border">
        <h2 class="text-xl font-semibold dark:text-dark-text">Buscar Fuente de Noticias</h2>
        <button id="searchModalClose" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-4 flex-1 overflow-y-auto">
        <div class="relative mb-4">
          <input id="searchInput" type="text" placeholder="Ej: Clarín, La Nación, Infobae, Página 12 o pega un dominio..."
                 class="w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text"/>
          <button id="searchBtn" class="absolute right-2 top-1/2 transform -translate-y-1/2 p-2 text-blue-600 hover:text-blue-700 dark:text-blue-400 dark:hover:text-blue-300">
            <i class="fas fa-search"></i>
          </button>
        </div>
        <div id="searchResults" class="space-y-2"></div>
        <div id="searchLoading" class="hidden flex justify-center items-center py-8">
          <div class="loader"></div>
        </div>
        <div id="searchEmpty" class="hidden text-center py-8">
          <i class="fas fa-search text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
          <p class="text-gray-500 dark:text-gray-400">Ingresa un término de búsqueda para encontrar fuentes de noticias</p>
        </div>
      </div>
    </div>
  </div>

  <!-- Chatbot -->
  <div id="chatbotContainer" class="fixed bottom-4 right-4 z-50">
    <button id="chatbotToggle" class="bg-blue-600 text-white rounded-full p-4 shadow-lg hover:bg-blue-700 transition">
      <i class="fas fa-comments text-xl"></i>
    </button>
    <div id="chatbotWindow" class="hidden bg-white rounded-lg shadow-xl w-80 h-96 flex flex-col dark:bg-dark-card dark:border dark:border-dark-border">
      <div class="bg-blue-600 text-white p-3 rounded-t-lg flex items-center justify-between">
        <h3 class="font-semibold">Asistente de Noticias IA</h3>
        <button id="chatbotClose" class="text-white hover:text-gray-200">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="chatMessages" class="flex-1 overflow-y-auto p-3 space-y-3"></div>
      <div class="p-3 border-t dark:border-dark-border">
        <div class="flex space-x-2">
          <input id="chatInput" type="text" placeholder="Escribe tu pregunta..."
                 class="flex-1 px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text"/>
          <button id="chatSendBtn" class="px-3 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Notifications -->
  <div id="notificationContainer" class="fixed top-20 right-4 z-50 space-y-2"></div>

  <!-- News Modal -->
  <div id="newsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-hidden flex flex-col dark:bg-dark-card dark:border dark:border-dark-border">
      <div class="p-4 border-b flex items-center justify-between dark:border-dark-border">
        <h2 id="modalTitle" class="text-xl font-semibold dark:text-dark-text"></h2>
        <button id="modalClose" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      <div class="p-4 overflow-y-auto flex-1">
        <div id="modalContent" class="prose max-w-none dark:prose-invert"></div>
      </div>
      <div class="p-4 border-t flex justify-between dark:border-dark-border">
        <div id="modalTags" class="flex flex-wrap gap-2"></div>
        <div class="flex space-x-2">
          <button id="modalMarkRead" class="px-3 py-1 bg-gray-200 text-gray-700 rounded hover:bg-gray-300 transition dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text dark:hover:bg-gray-700">
            <i class="fas fa-check mr-1"></i>Marcar como leído
          </button>
          <button id="modalOpenOriginal" class="px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
            <i class="fas fa-external-link-alt mr-1"></i>Abrir Original
          </button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // =========== Utils ===========
    function debounce(fn, delay = 350) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); };
    }
    function slugify(str) {
      return (str || '')
        .toLowerCase()
        .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
        .replace(/[^a-z0-9]+/g, ' ')
        .trim().replace(/\s+/g, '-');
    }
    function isLikelyUrlOrDomain(str) {
      return /^(https?:\/\/)?([\w-]+\.)+[\w-]{2,}(\/.*)?$/.test(str);
    }
    function toCandidateBaseUrl(str) {
      try { if (!/^https?:\/\//i.test(str)) str = 'https://' + str; const u = new URL(str); return u.origin; }
      catch { return null; }
    }
    function jsonp(url, param = 'callback', timeout = 8000) {
      return new Promise((resolve, reject) => {
        const cbName = 'jsonp_cb_' + Math.random().toString(36).slice(2);
        const s = document.createElement('script');
        const sep = url.includes('?') ? '&' : '?';
        s.src = `${url}${sep}${param}=${cbName}`;
        let done = false;
        window[cbName] = (data) => {
          if (done) return; done = true;
          resolve(data);
          cleanup();
        };
        s.onerror = () => { if (done) return; done = true; reject(new Error('JSONP error')); cleanup(); };
        const to = setTimeout(() => { if (done) return; done = true; reject(new Error('JSONP timeout')); cleanup(); }, timeout);
        function cleanup() {
          clearTimeout(to);
          delete window[cbName];
          s.remove();
        }
        document.body.appendChild(s);
      });
    }
    async function fetchJsonWithFallback(url, jsonpParam = 'callback') {
      try {
        const r = await fetch(url);
        if (!r.ok) throw new Error('HTTP ' + r.status);
        return await r.json();
      } catch (e) {
        return await jsonp(url, jsonpParam);
      }
    }

    // =========== App State ===========
    const app = {
      sources: [], tags: [], news: [],
      activeFilters: { source: null, tags: [], unread: false },
      viewMode: 'list', sortBy: 'date',
      chatHistory: [], currentNewsDetail: null,
      darkMode: false
    };

    // =========== Base de medios (AR + otros relevantes) ===========
    // Amplía fácilmente agregando más entradas.
    const newsSourcesDatabase = [
      // Nacionales grandes
      { name: 'Clarín', url: 'https://www.clarin.com', keywords: ['clarin','argentina','noticias'] },
      { name: 'La Nación', url: 'https://www.lanacion.com.ar', keywords: ['lanacion','nacion','argentina'] },
      { name: 'Infobae', url: 'https://www.infobae.com', keywords: ['infobae','argentina','noticias'] },
      { name: 'Página 12', url: 'https://www.pagina12.com.ar', keywords: ['pagina12','pagina 12','argentina'] },
      { name: 'Perfil', url: 'https://www.perfil.com', keywords: ['perfil','noticias'] },
      { name: 'Ámbito', url: 'https://www.ambito.com', keywords: ['ambito','finanzas'] },
      { name: 'El Cronista', url: 'https://www.cronista.com', keywords: ['cronista','economia'] },
      { name: 'Télam', url: 'https://www.telam.com.ar', keywords: ['telam','agencia'] },
      { name: 'BAE Negocios', url: 'https://www.baenegocios.com', keywords: ['bae','negocios'] },
      { name: 'iProfesional', url: 'https://www.iprofesional.com', keywords: ['iprofesional'] },
      { name: 'Minuto Uno', url: 'https://www.minutouno.com', keywords: ['minuto uno','m1'] },
      { name: 'Diario Popular', url: 'https://www.diariopopular.com.ar', keywords: ['popular'] },
      { name: 'Crónica', url: 'https://www.cronica.com.ar', keywords: ['cronica'] },
      { name: 'TN - Todo Noticias', url: 'https://tn.com.ar', keywords: ['tn','todo noticias'] },
      { name: 'C5N', url: 'https://www.c5n.com', keywords: ['c5n'] },
      { name: 'A24', url: 'https://www.a24.com', keywords: ['a24'] },
      { name: 'El Destape', url: 'https://www.eldestapeweb.com', keywords: ['el destape'] },
      { name: 'Tiempo Argentino', url: 'https://www.tiempoar.com.ar', keywords: ['tiempo argentino'] },
      { name: 'La Política Online', url: 'https://www.lapoliticaonline.com', keywords: ['lpo','politica online'] },
      { name: 'El Diario AR', url: 'https://www.eldiarioar.com', keywords: ['eldiarioar','el diario ar'] },
      { name: 'Chequeado', url: 'https://chequeado.com', keywords: ['chequeado','fact checking'] },
      { name: 'Forbes Argentina', url: 'https://www.forbesargentina.com', keywords: ['forbes'] },

      // Deportivos
      { name: 'Olé', url: 'https://www.ole.com.ar', keywords: ['ole','deportes'] },
      { name: 'TyC Sports', url: 'https://www.tycsports.com', keywords: ['tyc','deportes'] },

      // Regionales
      { name: 'La Voz del Interior', url: 'https://www.lavoz.com.ar', keywords: ['lavoz','cordoba'] },
      { name: 'Los Andes', url: 'https://www.losandes.com.ar', keywords: ['los andes','mendoza'] },
      { name: 'MDZ Online', url: 'https://www.mdzol.com', keywords: ['mdz','mendoza'] },
      { name: 'Diario Uno', url: 'https://www.diariouno.com.ar', keywords: ['diario uno','mendoza'] },
      { name: 'El Litoral', url: 'https://www.ellitoral.com', keywords: ['el litoral','santa fe'] },
      { name: 'Rosario3', url: 'https://www.rosario3.com', keywords: ['rosario3','rosario'] },
      { name: 'La Capital (Rosario)', url: 'https://www.lacapital.com.ar', keywords: ['la capital','rosario'] },
      { name: 'La Gaceta', url: 'https://www.lagaceta.com.ar', keywords: ['la gaceta','tucuman'] },
      { name: 'El Tribuno', url: 'https://www.eltribuno.com', keywords: ['el tribuno','salta','jujuy'] },
      { name: 'Río Negro', url: 'https://www.rionegro.com.ar', keywords: ['rio negro','patagonia'] },
      { name: 'La Voz del Pueblo', url: 'https://www.lavozdelpueblo.com.ar', keywords: ['tres arroyos'] },
      { name: 'El Día', url: 'https://www.eldia.com', keywords: ['el dia','la plata'] },
      { name: 'El Liberal', url: 'https://www.elliberal.com.ar', keywords: ['santiago del estero'] },
      { name: 'El Ancasti', url: 'https://www.elancasti.com.ar', keywords: ['catamarca'] },
      { name: 'Diario de Cuyo', url: 'https://www.diariodecuyo.com.ar', keywords: ['san juan'] },
      { name: 'El Territorio', url: 'https://www.elterritorio.com.ar', keywords: ['misiones'] },
      { name: 'Tiempo Sur', url: 'https://www.tiemposur.com.ar', keywords: ['santa cruz'] },
      { name: 'LM Neuquén', url: 'https://www.lmneuquen.com', keywords: ['neuquen'] },
      { name: 'La Voz (Chaco Diario Norte)', url: 'https://www.diarionorte.com', keywords: ['chaco','norte'] },
      { name: 'El Litoral (Corrientes)', url: 'https://www.ellitoral.com.ar', keywords: ['corrientes'] },
      { name: 'El Tribuno Jujuy', url: 'https://www.eltribuno.com/jujuy', keywords: ['jujuy'] },

      // Otros medios
      { name: 'BA Herald', url: 'https://www.buenosairesherald.com', keywords: ['herald','ingles'] },
      { name: 'Ámbito Financiero', url: 'https://www.ambito.com', keywords: ['ambito'] },
      { name: 'Crónica TV', url: 'https://www.cronicatv.com.ar', keywords: ['cronica tv'] },
      { name: 'Nexofin', url: 'https://www.nexofin.com', keywords: ['nexofin'] },
      { name: 'Infocielo', url: 'https://www.infocielo.com', keywords: ['infocielo'] },
      { name: 'El Doce TV', url: 'https://eldoce.tv', keywords: ['eldoce','cordoba'] },
      { name: 'El Cronista - Apertura', url: 'https://www.apertura.com', keywords: ['apertura'] }
    ];

    // =========== Init ===========
    document.addEventListener('DOMContentLoaded', () => {
      loadFromLocalStorage();
      renderSourcesList(); renderTags(); renderNews();
      initializeEventListeners(); initializeChatbot(); initializeDarkMode();

      if (app.sources.length === 0) {
        showNotification('¡Bienvenido a NewsHub! Haz clic en "Buscar Fuente" para agregar sitios de noticias.', 'info');
      }
      if (location.protocol === 'file:') {
        // Info suave, funciona igual
        console.log('Ejecutando con file:// - OK. El buscador usa APIs con CORS/JSONP.');
      }
    });

    // =========== Dark Mode ===========
    function initializeDarkMode() {
      app.darkMode = localStorage.getItem('newsHubDarkMode') === 'true';
      document.documentElement.classList.toggle('dark', app.darkMode);
      updateDarkModeToggle();
    }
    function toggleDarkMode() {
      app.darkMode = !app.darkMode;
      document.documentElement.classList.toggle('dark', app.darkMode);
      localStorage.setItem('newsHubDarkMode', app.darkMode);
      updateDarkModeToggle();
    }
    function updateDarkModeToggle() {
      document.getElementById('darkModeToggle').innerHTML = app.darkMode ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
    }

    // =========== Storage ===========
    function saveToLocalStorage() {
      localStorage.setItem('newsHubState', JSON.stringify({
        sources: app.sources, tags: app.tags, news: app.news, chatHistory: app.chatHistory
      }));
    }
    function loadFromLocalStorage() {
      const saved = localStorage.getItem('newsHubState');
      if (!saved) return;
      try {
        const s = JSON.parse(saved);
        app.sources = s.sources || [];
        app.tags = s.tags || [];
        app.news = s.news || [];
        app.chatHistory = s.chatHistory || [];
      } catch (e) { console.error('Error parsing state', e); }
    }

    // =========== Events ===========
    function initializeEventListeners() {
      document.getElementById('darkModeToggle').addEventListener('click', toggleDarkMode);
      document.getElementById('addSourceBtn').addEventListener('click', openSearchModal);
      document.getElementById('searchModalClose').addEventListener('click', closeSearchModal);

      const performSearchDebounced = debounce(performSearch, 280);
      document.getElementById('searchBtn').addEventListener('click', performSearch);
      document.getElementById('searchInput').addEventListener('input', performSearchDebounced);
      document.getElementById('searchInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });

      document.getElementById('refreshAllBtn').addEventListener('click', refreshAllSources);
      document.getElementById('addTagBtn').addEventListener('click', addTag);
      document.getElementById('newTagInput').addEventListener('keypress', (e) => { if (e.key === 'Enter') addTag(); });

      document.getElementById('filterAllBtn').addEventListener('click', () => {
        app.activeFilters.source = null; app.activeFilters.tags = []; app.activeFilters.unread = false; renderNews();
      });
      document.getElementById('filterUnreadBtn').addEventListener('click', () => {
        app.activeFilters.unread = !app.activeFilters.unread; renderNews();
      });
      document.getElementById('sortBySelect').addEventListener('change', (e) => { app.sortBy = e.target.value; renderNews(); });
      document.getElementById('viewGridBtn').addEventListener('click', () => { app.viewMode = 'grid'; updateViewModeButtons(); renderNews(); });
      document.getElementById('viewListBtn').addEventListener('click', () => { app.viewMode = 'list'; updateViewModeButtons(); renderNews(); });

      document.getElementById('modalClose').addEventListener('click', closeModal);
      document.getElementById('modalMarkRead').addEventListener('click', () => {
        if (app.currentNewsDetail) { markAsRead(app.currentNewsDetail.id); closeModal(); renderNews(); }
      });
      document.getElementById('modalOpenOriginal').addEventListener('click', () => {
        if (app.currentNewsDetail) window.open(app.currentNewsDetail.link, '_blank');
      });
    }
    function updateViewModeButtons() {
      const gridBtn = document.getElementById('viewGridBtn');
      const listBtn = document.getElementById('viewListBtn');
      if (app.viewMode === 'grid') {
        gridBtn.classList.add('bg-blue-600','text-white');
        gridBtn.classList.remove('bg-gray-200','text-gray-700','dark:bg-dark-card','dark:border-dark-border','dark:text-dark-text');
        listBtn.classList.remove('bg-blue-600','text-white');
        listBtn.classList.add('bg-gray-200','text-gray-700','dark:bg-dark-card','dark:border-dark-border','dark:text-dark-text');
      } else {
        listBtn.classList.add('bg-blue-600','text-white');
        listBtn.classList.remove('bg-gray-200','text-gray-700','dark:bg-dark-card','dark:border-dark-border','dark:text-dark-text');
        gridBtn.classList.remove('bg-blue-600','text-white');
        gridBtn.classList.add('bg-gray-200','text-gray-700','dark:bg-dark-card','dark:border-dark-border','dark:text-dark-text');
      }
    }

    // =========== Search Modal ===========
    function openSearchModal() {
      document.getElementById('searchModal').classList.remove('hidden');
      document.getElementById('searchInput').value = '';
      document.getElementById('searchResults').innerHTML = '';
      document.getElementById('searchLoading').classList.add('hidden');
      document.getElementById('searchEmpty').classList.remove('hidden');
      document.getElementById('searchInput').focus();
    }
    function closeSearchModal() {
      document.getElementById('searchModal').classList.add('hidden');
    }

    // =========== Search (sin proxy, con JSONP fallback) ===========
    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      const container = document.getElementById('searchResults');
      container.innerHTML = '';
      document.getElementById('searchEmpty').classList.add('hidden');
      if (!query) {
        document.getElementById('searchEmpty').classList.remove('hidden');
        return;
      }
      document.getElementById('searchLoading').classList.remove('hidden');

      try {
        // 1) Local fuzzy
        const local = searchInDatabase(query);

        // 2) Manual: si parece dominio/URL o podemos deducir
        const manual = [];
        const urlCandidate = isLikelyUrlOrDomain(query) ? toCandidateBaseUrl(query) : null;
        if (urlCandidate) {
          manual.push({ title: urlCandidate.replace(/^https?:\/\//,''), url: urlCandidate, description: 'Agregar por URL (descubrir RSS)', type: 'manual' });
        } else {
          const s = slugify(query).replace(/-/g,'');
          if (s && s.length >= 3) {
            const guesses = [
              `https://www.${s}.com.ar`, `https://${s}.com.ar`,
              `https://www.${s}.com`, `https://${s}.com`
            ];
            guesses.forEach(u => manual.push({ title: u.replace(/^https?:\/\//,''), url: u, description: 'Probar dominio (descubrir RSS)', type: 'manual' }));
          }
        }

        // 3) Web: DuckDuckGo Instant Answer API (CORS OK + JSONP fallback)
        const web = await searchWebNoProxy(query);

        // Combinar y deduplicar
        const all = [...local, ...manual, ...web];
        const unique = [];
        const seen = new Set();
        for (const r of all) {
          if (!r || !r.url || !r.title) continue;
          const key = (r.url.toLowerCase().replace(/^https?:\/\/(www\.)?/,'').replace(/\/$/,'')) + '|' + r.title.toLowerCase().trim();
          if (seen.has(key)) continue;
          seen.add(key);
          unique.push(r);
        }

        // Orden: database > manual > web, afinado por coincidencia
        unique.sort((a, b) => {
          const order = (t) => t==='database'?0: t==='manual'?1:2;
          const oa = order(a.type||'web'), ob = order(b.type||'web');
          if (oa !== ob) return oa - ob;
          const q = query.toLowerCase();
          const an = a.title.toLowerCase(), bn = b.title.toLowerCase();
          if (an === q && bn !== q) return -1;
          if (bn === q && an !== q) return 1;
          const ai = an.includes(q), bi = bn.includes(q);
          if (ai && !bi) return -1; if (!ai && bi) return 1;
          return 0;
        });

        displaySearchResults(unique.slice(0,12));
      } catch (e) {
        console.error('Search error', e);
        showNotification('Error en la búsqueda. Intenta nuevamente.', 'error');
        displaySearchResults([]);
      } finally {
        document.getElementById('searchLoading').classList.add('hidden');
      }
    }

    function searchInDatabase(query) {
      const q = query.toLowerCase().trim();
      const results = [];
      newsSourcesDatabase.forEach(src => {
        let score = 0;
        const name = src.name.toLowerCase();
        const kws = (src.keywords || []).map(k => k.toLowerCase());

        if (name === q) score += 1000;
        if (name.startsWith(q)) score += 500;
        if (name.includes(q)) score += 320;
        if (kws.includes(q)) score += 260;
        if (kws.some(k => k.startsWith(q))) score += 180;
        if (kws.some(k => k.includes(q))) score += 120;

        const words = q.split(/\s+/).filter(Boolean);
        const matchWords = words.filter(w => name.includes(w) || kws.some(k => k.includes(w))).length;
        score += matchWords * 70;

        if (score > 0) {
          results.push({ title: src.name, url: src.url, description: `Fuente verificada - ${src.name}`, type: 'database', score });
        }
      });
      results.sort((a,b)=>b.score-a.score);
      return results.slice(0,10);
    }

    async function searchWebNoProxy(query) {
      try {
        const url = `https://api.duckduckgo.com/?q=${encodeURIComponent(query + ' sitio noticias')}&format=json&no_html=1&skip_disambig=1`;
        const data = await fetchJsonWithFallback(url, 'callback');
        const results = [];

        function handleTopic(t) {
          if (!t) return;
          if (Array.isArray(t.Topics)) {
            t.Topics.forEach(handleTopic);
            return;
          }
          const first = t.FirstURL || t.firstURL || t.Url || t.url;
          const text = t.Text || t.text || '';
          if (!first) return;
          try {
            const u = new URL(first);
            const origin = u.origin;
            if (/(wikipedia|duckduckgo|facebook|instagram|twitter|youtube)\.com/i.test(origin)) return;
            const title = text ? text.split(' - ')[0] : origin.replace(/^https?:\/\//,'');
            results.push({ title: title || origin, url: origin, description: 'Resultado web (descubrir RSS)', type: 'web' });
          } catch {}
        }

        if (Array.isArray(data.RelatedTopics)) data.RelatedTopics.forEach(handleTopic);
        // A veces vienen en Results directos
        if (Array.isArray(data.Results)) data.Results.forEach(handleTopic);

        // Dedupe por dominio
        const seen = new Set();
        return results.filter(r => {
          const k = r.url.toLowerCase();
          if (seen.has(k)) return false;
          seen.add(k);
          return true;
        }).slice(0, 10);
      } catch (e) {
        console.warn('DDG fallback failed', e);
        return [];
      }
    }

    function displaySearchResults(results) {
      const container = document.getElementById('searchResults');
      container.innerHTML = '';
      if (results.length === 0) {
        document.getElementById('searchEmpty').classList.remove('hidden');
        container.innerHTML = `
          <div class="text-center py-8">
            <i class="fas fa-search text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
            <p class="text-gray-500 dark:text-gray-400">No se encontraron resultados para "${document.getElementById('searchInput').value}"</p>
            <p class="text-sm text-gray-400 dark:text-gray-500 mt-2">Intenta con nombres como "Clarín", "La Nación", "Infobae" o pega un dominio (ej: sitio.com)</p>
          </div>`;
        return;
      }

      const databaseResults = results.filter(r => r.type === 'database');
      const others = results.filter(r => r.type !== 'database');

      if (databaseResults.length > 0) {
        const h = document.createElement('div');
        h.className = 'mb-3 px-2';
        h.innerHTML = `
          <h3 class="text-sm font-semibold text-green-600 dark:text-green-400 flex items-center">
            <i class="fas fa-check-circle mr-2"></i>Fuentes Verificadas (${databaseResults.length})
          </h3>`;
        container.appendChild(h);
        databaseResults.forEach(r => container.appendChild(createSearchResultElement(r, true)));
      }
      if (others.length > 0) {
        const h = document.createElement('div');
        h.className = 'mb-3 px-2 mt-6';
        h.innerHTML = `
          <h3 class="text-sm font-semibold text-blue-600 dark:text-blue-400 flex items-center">
            <i class="fas fa-globe mr-2"></i>Otras coincidencias (${others.length})
          </h3>`;
        container.appendChild(h);
        others.forEach(r => container.appendChild(createSearchResultElement(r, false)));
      }
    }

    function createSearchResultElement(result, isVerified) {
      const el = document.createElement('div');
      el.className = 'search-result p-4 border rounded-lg cursor-pointer mb-2 dark:border-dark-border transition-all duration-200';
      const favicon = `https://www.google.com/s2/favicons?domain=${result.url}&sz=32`;
      const badge = isVerified
        ? '<span class="text-xs text-green-600 dark:text-green-400 flex items-center whitespace-nowrap"><i class="fas fa-check-circle mr-1"></i>Verificada</span>'
        : (result.type === 'manual'
          ? '<span class="text-xs text-yellow-600 dark:text-yellow-400 flex items-center whitespace-nowrap"><i class="fas fa-magic mr-1"></i>Descubrir feed</span>'
          : '<span class="text-xs text-blue-600 dark:text-blue-400 flex items-center whitespace-nowrap"><i class="fas fa-globe mr-1"></i>Web</span>');

      el.innerHTML = `
        <div class="flex items-start space-x-3">
          <img src="${favicon}" alt="" class="w-8 h-8 rounded"
               onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%239ca3af%22><path d=%22M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-5 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z%22/></svg>'">
          <div class="flex-1 min-w-0">
            <div class="flex items-start justify-between">
              <h3 class="font-semibold text-lg dark:text-dark-text pr-2">${result.title}</h3>
              ${badge}
            </div>
            <p class="text-gray-600 dark:text-gray-400 text-sm mt-1 line-clamp-2">${result.description || 'Sitio de noticias'}</p>
            <p class="text-blue-600 dark:text-blue-400 text-xs mt-2 truncate">
              <i class="fas fa-link mr-1"></i>${result.url}
            </p>
          </div>
          <button class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition whitespace-nowrap flex items-center"
                  onclick="event.stopPropagation(); selectSearchResult(${JSON.stringify(result).replace(/"/g, '&quot;')})">
            <i class="fas fa-plus mr-2"></i>Agregar
          </button>
        </div>
      `;
      el.addEventListener('click', (e) => { if (!e.target.closest('button')) window.open(result.url, '_blank'); });
      return el;
    }

    // =========== Agregar fuente (descubrir feed sin CORS) ===========
    async function selectSearchResult(result) {
      try {
        showLoading(true);
        showNotification('Agregando fuente de noticias...', 'info');
        closeSearchModal();

        // Evitar duplicados por nombre o URL base
        const norm = (u)=> (u||'').toLowerCase().replace(/^https?:\/\//,'').replace(/^www\./,'').replace(/\/$/,'');
        const exists = app.sources.find(s =>
          norm(s.url) === norm(result.url) || s.name.toLowerCase() === (result.title||'').toLowerCase()
        );
        if (exists) {
          showLoading(false);
          showNotification('Esta fuente ya está agregada', 'warning');
          return;
        }

        let newsItems = [];
        let sourceUrl = result.url;
        let sourceType = 'rss';

        // Si no es un feed directo, intentar descubrir
        if (!/(\.xml$|\/rss|\/feed|\/atom)/i.test(sourceUrl)) {
          const origin = toCandidateBaseUrl(sourceUrl) || sourceUrl;
          const discovered = await findRSSFeedWithoutCORS(origin);
          if (discovered) {
            sourceUrl = discovered;
          } else {
            showNotification('No encontramos RSS en esa URL. Probá otra o indica un feed directo.', 'warning');
          }
        }

        // Si tenemos un feed, leerlo
        if (/(\.xml$|\/rss|\/feed|\/atom)/i.test(sourceUrl)) {
          try {
            newsItems = await fetchRSSFeed(sourceUrl);
            sourceType = 'rss';
          } catch (e) { console.log('RSS error:', e.message); }
        }

        if (newsItems && newsItems.length > 0) {
          const source = { id: generateId(), name: result.title, url: sourceUrl, type: sourceType, lastUpdated: new Date() };
          app.sources.push(source);
          newsItems.forEach(item => { item.sourceId = source.id; item.sourceName = source.name; app.news.push(item); });
          saveToLocalStorage();
          renderSourcesList(); renderNews();
          showNotification(`Fuente "${result.title}" agregada con ${newsItems.length} noticias`, 'success');
        } else {
          showNotification('No pudimos obtener contenido de esta fuente. Intenta con otra o pega un feed RSS directo.', 'error');
        }
      } catch (e) {
        console.error('Error agregando fuente:', e);
        showNotification('Error al agregar la fuente: ' + e.message, 'error');
      } finally {
        showLoading(false);
      }
    }

    async function findRSSFeedWithoutCORS(baseUrl) {
      const origin = toCandidateBaseUrl(baseUrl) || baseUrl;
      const candidates = [
        '/rss', '/rss.xml', '/feed', '/feed.xml', '/atom.xml', '/index.xml',
        '/feeds/posts/default', '/feeds/posts/default?alt=rss',
        '/?feed=rss', '/?feed=rss2', '/?feed=atom'
      ].map(p => new URL(p, origin).href);

      for (const testUrl of candidates) {
        const ok = await verifyFeedWithRss2Json(testUrl);
        if (ok) return testUrl;
      }
      return null;
    }

    async function verifyFeedWithRss2Json(feedUrl) {
      try {
        const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(feedUrl)}`;
        const data = await fetchJsonWithFallback(api, 'callback');
        return data && data.status === 'ok' && Array.isArray(data.items) && data.items.length > 0;
      } catch {
        return false;
      }
    }

    async function fetchRSSFeed(url) {
      showNotification('Obteniendo noticias del feed RSS...', 'info');
      const api = `https://api.rss2json.com/v1/api.json?rss_url=${encodeURIComponent(url)}`;
      const data = await fetchJsonWithFallback(api, 'callback');
      if (!(data && data.status === 'ok' && Array.isArray(data.items) && data.items.length > 0)) {
        throw new Error('RSS vacío o inválido');
      }
      return data.items.map(item => ({
        id: generateId(),
        title: item.title || 'Sin título',
        description: stripHtml(item.description || item.content) || '',
        content: stripHtml(item.content || item.description) || '',
        link: item.link || item.guid || '#',
        pubDate: item.pubDate ? new Date(item.pubDate) : new Date(),
        author: item.author || '',
        image: item.enclosure?.link || item.thumbnail || extractImageFromContent(item.content || item.description),
        read: false, tags: []
      }));
    }

    // =========== Fuentes / Noticias ===========
    async function refreshSource(source) {
      try {
        let newsItems = [];
        if (source.type === 'rss') newsItems = await fetchRSSFeed(source.url);

        if (newsItems && newsItems.length > 0) {
          app.news = app.news.filter(i => i.sourceId !== source.id);
          newsItems.forEach(i => { i.sourceId = source.id; i.sourceName = source.name; app.news.push(i); });
          const idx = app.sources.findIndex(s => s.id === source.id);
          if (idx !== -1) app.sources[idx].lastUpdated = new Date();
          saveToLocalStorage(); renderNews();
          showNotification(`Fuente "${source.name}" actualizada`, 'success');
        } else {
          showNotification(`No se encontraron noticias en "${source.name}"`, 'warning');
        }
      } catch (e) {
        console.error('Error refreshing source:', e);
        showNotification(`Error al actualizar "${source.name}": ${e.message}`, 'error');
      }
    }
    async function refreshAllSources() {
      showLoading(true);
      for (const s of app.sources) { await refreshSource(s); }
      showLoading(false); renderNews();
      showNotification('Todas las fuentes han sido actualizadas', 'success');
    }

    function removeSource(sourceId) {
      app.sources = app.sources.filter(s => s.id !== sourceId);
      app.news = app.news.filter(n => n.sourceId !== sourceId);
      saveToLocalStorage(); renderSourcesList(); renderNews();
      showNotification('Fuente eliminada', 'info');
    }

    // =========== Tags ===========
    function addTag() {
      const input = document.getElementById('newTagInput');
      const v = input.value.trim(); if (!v) return;
      if (!app.tags.includes(v)) {
        app.tags.push(v); saveToLocalStorage(); renderTags();
        showNotification(`Palabra clave "${v}" agregada`, 'success');
      }
      input.value = '';
    }
    function removeTag(tag) {
      app.tags = app.tags.filter(t => t !== tag);
      app.news.forEach(i => { i.tags = i.tags.filter(t => t !== tag); });
      app.activeFilters.tags = app.activeFilters.tags.filter(t => t !== tag);
      saveToLocalStorage(); renderTags(); renderNews();
      showNotification(`Palabra clave "${tag}" eliminada`, 'info');
    }
    function toggleTagFilter(tag) {
      const i = app.activeFilters.tags.indexOf(tag);
      if (i === -1) app.activeFilters.tags.push(tag); else app.activeFilters.tags.splice(i,1);
      renderTags(); renderNews();
    }

    // =========== News UI ===========
    function markAsRead(newsId) {
      const item = app.news.find(i => i.id === newsId);
      if (item) { item.read = true; saveToLocalStorage(); }
    }
    function addTagToNews(newsId, tag) {
      const item = app.news.find(i => i.id === newsId);
      if (item && !item.tags.includes(tag)) { item.tags.push(tag); saveToLocalStorage(); renderNews(); }
    }
    function removeTagFromNews(newsId, tag) {
      const item = app.news.find(i => i.id === newsId);
      if (item) { item.tags = item.tags.filter(t => t !== tag); saveToLocalStorage(); renderNews(); }
    }

    function openNewsModal(newsId) {
      const item = app.news.find(i => i.id === newsId);
      if (!item) return;
      app.currentNewsDetail = item;

      document.getElementById('modalTitle').textContent = item.title;
      document.getElementById('modalContent').innerHTML = `
        <div class="mb-4">
          ${item.image ? `<img src="${item.image}" alt="${item.title}" class="w-full max-h-64 object-cover rounded mb-4">` : ''}
          <p class="text-gray-600 mb-2 dark:text-gray-400">
            <i class="fas fa-newspaper mr-1"></i> ${item.sourceName}
            <span class="mx-2">|</span>
            <i class="fas fa-calendar mr-1"></i> ${formatDate(item.pubDate)}
            ${item.author ? `<span class="mx-2">|</span><i class="fas fa-user mr-1"></i> ${item.author}` : ''}
          </p>
        </div>
        <div class="prose max-w-none dark:prose-invert">${item.content || item.description}</div>
      `;

      const tagsC = document.getElementById('modalTags');
      tagsC.innerHTML = '';
      item.tags.forEach(tag => {
        const span = document.createElement('span');
        span.className = 'px-2 py-1 bg-blue-100 text-blue-800 rounded-full text-sm dark:bg-blue-900 dark:text-blue-200';
        span.innerHTML = `${tag}
          <button class="ml-1 text-blue-600 hover:text-blue-800 dark:text-blue-400 dark:hover:text-blue-200" onclick="removeTagFromNews('${newsId}', '${tag}')">
            <i class="fas fa-times"></i>
          </button>`;
        tagsC.appendChild(span);
      });
      const select = document.createElement('select');
      select.className = 'px-2 py-1 border border-gray-300 rounded text-sm dark:bg-dark-card dark:border-dark-border dark:text-dark-text';
      select.innerHTML = '<option value="">Añadir palabra clave...</option>';
      app.tags.forEach(tag => {
        if (!item.tags.includes(tag)) {
          const opt = document.createElement('option'); opt.value = tag; opt.textContent = tag; select.appendChild(opt);
        }
      });
      select.addEventListener('change',(e)=>{ if (e.target.value) { addTagToNews(newsId, e.target.value); openNewsModal(newsId); }});
      tagsC.appendChild(select);

      document.getElementById('newsModal').classList.remove('hidden');
      markAsRead(newsId);
    }
    function closeModal() {
      document.getElementById('newsModal').classList.add('hidden');
      app.currentNewsDetail = null;
    }

    function renderSourcesList() {
      const c = document.getElementById('sourcesList');
      const no = document.getElementById('noSources');

      if (app.sources.length === 0) {
        c.innerHTML = ''; no.classList.remove('hidden');
      } else {
        c.innerHTML = ''; no.classList.add('hidden');
        app.sources.forEach(source => {
          const el = document.createElement('div');
          el.className = 'flex items-center justify-between p-2 rounded hover:bg-gray-100 transition dark:hover:bg-gray-700';
          el.dataset.sourceId = source.id;
          el.innerHTML = `
            <div class="flex items-center space-x-2">
              <i class="fas fa-rss text-blue-600 dark:text-blue-400"></i>
              <span class="font-medium dark:text-dark-text">${source.name}</span>
            </div>
            <div class="flex space-x-1">
              <button class="p-1 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400"
                      onclick="refreshSource(${JSON.stringify(source).replace(/"/g,'&quot;')})">
                <i class="fas fa-sync-alt"></i>
              </button>
              <button class="p-1 text-gray-500 hover:text-red-600 dark:text-gray-400 dark:hover:text-red-400"
                      onclick="removeSource('${source.id}')">
                <i class="fas fa-trash"></i>
              </button>
            </div>`;
          el.addEventListener('click', (e) => {
            if (e.target.closest('button')) return;
            app.activeFilters.source = source.id; renderNews();
            document.getElementById('currentViewTitle').textContent = source.name;
          });
          c.appendChild(el);
        });
      }
      renderSourceTabs();
    }

    function renderSourceTabs() {
      const c = document.getElementById('sourceTabs');
      c.innerHTML = '';
      const allTab = document.createElement('button');
      allTab.className = `source-tab px-3 py-1 rounded-t-lg whitespace-nowrap ${!app.activeFilters.source ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text'}`;
      allTab.textContent = 'Todas las Fuentes';
      allTab.addEventListener('click', () => {
        app.activeFilters.source = null; renderNews();
        document.getElementById('currentViewTitle').textContent = 'Todas las Noticias';
      });
      c.appendChild(allTab);

      app.sources.forEach(src => {
        const tab = document.createElement('button');
        tab.className = `source-tab px-3 py-1 rounded-t-lg whitespace-nowrap ${app.activeFilters.source === src.id ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text'}`;
        tab.textContent = src.name;
        tab.addEventListener('click', () => {
          app.activeFilters.source = src.id; renderNews();
          document.getElementById('currentViewTitle').textContent = src.name;
        });
        c.appendChild(tab);
      });
    }

    function renderTags() {
      const c = document.getElementById('tagsContainer');
      c.innerHTML = '';
      app.tags.forEach(tag => {
        const active = app.activeFilters.tags.includes(tag);
        const el = document.createElement('button');
        el.className = `tag-pill px-3 py-1 rounded-full text-sm ${active ? 'bg-blue-600 text-white' : 'bg-gray-200 text-gray-700 dark:bg-dark-card dark:border dark:border-dark-border dark:text-dark-text'}`;
        el.innerHTML = `
          ${tag}
          <button class="ml-1" onclick="event.stopPropagation(); removeTag('${tag}')">
            <i class="fas fa-times"></i>
          </button>`;
        el.addEventListener('click', () => toggleTagFilter(tag));
        c.appendChild(el);
      });
    }

    function renderNews() {
      const c = document.getElementById('newsContainer');
      const empty = document.getElementById('emptyState');

      let list = [...app.news];
      if (app.activeFilters.source) list = list.filter(i => i.sourceId === app.activeFilters.source);
      if (app.activeFilters.tags.length > 0) list = list.filter(i => app.activeFilters.tags.some(t => i.tags.includes(t)));
      if (app.activeFilters.unread) list = list.filter(i => !i.read);

      list.sort((a,b) => {
        switch (app.sortBy) {
          case 'date': return new Date(b.pubDate) - new Date(a.pubDate);
          case 'source': return (a.sourceName||'').localeCompare(b.sourceName||'');
          case 'title': return (a.title||'').localeCompare(b.title||'');
          default: return 0;
        }
      });

      if (list.length === 0) { c.innerHTML = ''; empty.classList.remove('hidden'); return; }
      empty.classList.add('hidden'); c.innerHTML = '';

      if (app.viewMode === 'list') {
        list.forEach(item => {
          const el = document.createElement('div');
          el.className = `news-item p-4 border rounded-lg ${item.read ? 'bg-gray-50 dark:bg-gray-800' : 'bg-white dark:bg-dark-card'} hover:shadow-md cursor-pointer dark:border-dark-border`;
          el.innerHTML = `
            <div class="flex items-start space-x-3">
              ${item.image ? `<img src="${item.image}" alt="${item.title}" class="w-20 h-20 object-cover rounded">`
                            : '<div class="w-20 h-20 bg-gray-200 dark:bg-gray-700 rounded flex items-center justify-center"><i class="fas fa-newspaper text-gray-400 dark:text-gray-500"></i></div>'}
              <div class="flex-1">
                <h3 class="font-semibold text-lg ${item.read ? 'text-gray-600 dark:text-gray-400' : 'text-gray-900 dark:text-dark-text'}">${item.title}</h3>
                <p class="text-gray-600 mt-1 dark:text-gray-400">${item.description ? item.description.substring(0,150) + '...' : ''}</p>
                <div class="flex items-center mt-2 text-sm text-gray-500 dark:text-gray-400">
                  <span><i class="fas fa-newspaper mr-1"></i> ${item.sourceName}</span>
                  <span class="mx-2">|</span>
                  <span><i class="fas fa-calendar mr-1"></i> ${formatDate(item.pubDate)}</span>
                  ${item.tags.length ? `
                    <span class="mx-2">|</span>
                    <div class="flex space-x-1">
                      ${item.tags.map(t=>`<span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs dark:bg-blue-900 dark:text-blue-200">${t}</span>`).join('')}
                    </div>` : ''
                  }
                </div>
              </div>
              <div class="flex flex-col space-y-2">
                ${!item.read
                  ? `<button class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" onclick="event.stopPropagation(); markAsRead('${item.id}'); renderNews();"><i class="fas fa-envelope"></i></button>`
                  : `<button class="p-2 text-blue-600 dark:text-blue-400" onclick="event.stopPropagation();"><i class="fas fa-envelope-open"></i></button>`
                }
                <button class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" onclick="event.stopPropagation(); window.open('${item.link}', '_blank')"><i class="fas fa-external-link-alt"></i></button>
              </div>
            </div>`;
          el.addEventListener('click', () => openNewsModal(item.id));
          c.appendChild(el);
        });
      } else {
        const grid = document.createElement('div');
        grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
        list.forEach(item => {
          const el = document.createElement('div');
          el.className = `news-item border rounded-lg overflow-hidden ${item.read ? 'bg-gray-50 dark:bg-gray-800' : 'bg-white dark:bg-dark-card'} hover:shadow-md cursor-pointer h-full flex flex-col dark:border-dark-border`;
          el.innerHTML = `
            ${item.image ? `<img src="${item.image}" alt="${item.title}" class="w-full h-40 object-cover">`
                          : '<div class="w-full h-40 bg-gray-200 dark:bg-gray-700 flex items-center justify-center"><i class="fas fa-newspaper text-gray-400 dark:text-gray-500 text-2xl"></i></div>'}
            <div class="p-4 flex-1 flex flex-col">
              <h3 class="font-semibold text-lg ${item.read ? 'text-gray-600 dark:text-gray-400' : 'text-gray-900 dark:text-dark-text'}">${item.title}</h3>
              <p class="text-gray-600 mt-1 flex-1 dark:text-gray-400">${item.description ? item.description.substring(0,100) + '...' : ''}</p>
              <div class="flex items-center justify-between mt-3 text-sm text-gray-500 dark:text-gray-400">
                <span><i class="fas fa-newspaper mr-1"></i> ${item.sourceName}</span>
                <span><i class="fas fa-calendar mr-1"></i> ${formatDate(item.pubDate)}</span>
              </div>
              ${item.tags.length ? `
                <div class="flex flex-wrap gap-1 mt-2">
                  ${item.tags.map(t=>`<span class="px-2 py-0.5 bg-blue-100 text-blue-800 rounded-full text-xs dark:bg-blue-900 dark:text-blue-200">${t}</span>`).join('')}
                </div>` : ''
              }
              <div class="flex justify-end space-x-2 mt-3">
                ${!item.read
                  ? `<button class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" onclick="event.stopPropagation(); markAsRead('${item.id}'); renderNews();"><i class="fas fa-envelope"></i></button>`
                  : `<button class="p-2 text-blue-600 dark:text-blue-400" onclick="event.stopPropagation();"><i class="fas fa-envelope-open"></i></button>`
                }
                <button class="p-2 text-gray-500 hover:text-blue-600 dark:text-gray-400 dark:hover:text-blue-400" onclick="event.stopPropagation(); window.open('${item.link}', '_blank')"><i class="fas fa-external-link-alt"></i></button>
              </div>
            </div>`;
          el.addEventListener('click', () => openNewsModal(item.id));
          grid.appendChild(el);
        });
        c.appendChild(grid);
      }
    }

    // =========== Chatbot ===========
    function initializeChatbot() {
      const t = document.getElementById('chatbotToggle');
      const w = document.getElementById('chatbotWindow');
      const c = document.getElementById('chatbotClose');
      const i = document.getElementById('chatInput');
      const s = document.getElementById('chatSendBtn');

      t.addEventListener('click', () => { w.classList.toggle('hidden'); if (!w.classList.contains('hidden')) renderChatMessages(); });
      c.addEventListener('click', () => w.classList.add('hidden'));
      s.addEventListener('click', sendChatMessage);
      i.addEventListener('keypress', (e) => { if (e.key === 'Enter') sendChatMessage(); });

      if (app.chatHistory.length === 0) {
        app.chatHistory.push({ role: 'assistant', content: '¡Hola! Soy tu asistente de noticias. ¿Qué medio te interesa hoy?' });
        saveToLocalStorage();
      }
    }
    function renderChatMessages() {
      const container = document.getElementById('chatMessages');
      container.innerHTML = '';
      app.chatHistory.forEach(m => {
        const el = document.createElement('div');
        el.className = `chat-message ${m.role === 'user' ? 'text-right' : 'text-left'}`;
        const bubble = m.role === 'user'
          ? 'bg-blue-600 text-white rounded-tl-lg rounded-tr-lg rounded-bl-lg'
          : 'bg-gray-200 text-gray-800 rounded-tl-lg rounded-tr-lg rounded-br-lg dark:bg-gray-700 dark:text-gray-200';
        el.innerHTML = `<div class="inline-block max-w-xs px-4 py-2 ${bubble}">${m.content}</div>`;
        container.appendChild(el);
      });
      container.scrollTop = container.scrollHeight;
    }
    async function sendChatMessage() {
      const i = document.getElementById('chatInput');
      const msg = i.value.trim(); if (!msg) return;
      app.chatHistory.push({ role: 'user', content: msg }); i.value=''; renderChatMessages();

      const typing = document.createElement('div');
      typing.className = 'chat-message text-left';
      typing.innerHTML = `
        <div class="inline-block max-w-xs px-4 py-2 bg-gray-200 text-gray-800 rounded-tl-lg rounded-tr-lg rounded-br-lg dark:bg-gray-700 dark:text-gray-200">
          <div class="flex space-x-1">
            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce"></div>
            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay:0.1s"></div>
            <div class="w-2 h-2 bg-gray-500 rounded-full animate-bounce" style="animation-delay:0.2s"></div>
          </div>
        </div>`;
      const container = document.getElementById('chatMessages');
      container.appendChild(typing); container.scrollTop = container.scrollHeight;

      try {
        const prompt = `Eres un asistente de noticias útil y amigable. Responde de forma concisa: ${msg}`;
        const r = await fetch('https://text.pollinations.ai/prompt/' + encodeURIComponent(prompt));
        if (!r.ok) throw new Error('API request failed');
        const text = await r.text();
        container.removeChild(typing);
        app.chatHistory.push({ role: 'assistant', content: text });
        saveToLocalStorage(); renderChatMessages();
      } catch (e) {
        console.error('Pollinations error', e);
        container.removeChild(typing);
        app.chatHistory.push({ role: 'assistant', content: 'No pude responder ahora. Intenta de nuevo más tarde.' });
        saveToLocalStorage(); renderChatMessages();
      }
    }

    // =========== Helpers ===========
    function generateId() { return Date.now().toString(36) + Math.random().toString(36).slice(2); }
    function formatDate(date) {
      if (!date) return '';
      if (!(date instanceof Date)) date = new Date(date);
      if (isNaN(date.getTime())) return 'Fecha desconocida';
      const now = new Date(); const diff = now - date; const days = Math.floor(diff/(1000*60*60*24));
      if (days === 0) {
        const hrs = Math.floor(diff/(1000*60*60));
        if (hrs === 0) { const min = Math.floor(diff/(1000*60)); return min <= 1 ? 'Ahora mismo' : `Hace ${min} minutos`; }
        return hrs === 1 ? 'Hace 1 hora' : `Hace ${hrs} horas`;
      } else if (days === 1) return 'Ayer';
      else if (days < 7) return `Hace ${days} días`;
      else return date.toLocaleDateString('es-ES', { day:'numeric', month:'short', year: date.getFullYear()!==now.getFullYear()? 'numeric': undefined });
    }
    function showNotification(message, type='info') {
      const c = document.getElementById('notificationContainer');
      const n = document.createElement('div');
      n.className = `notification px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 ${
        type==='success'?'bg-green-500 text-white':
        type==='error'?'bg-red-500 text-white':
        type==='warning'?'bg-yellow-500 text-white':'bg-blue-500 text-white'
      }`;
      const icon = type==='success'?'fa-check-circle': type==='error'?'fa-exclamation-circle': type==='warning'?'fa-exclamation-triangle':'fa-info-circle';
      n.innerHTML = `<i class="fas ${icon}"></i><span>${message}</span>`;
      c.appendChild(n);
      setTimeout(()=>{ n.style.opacity='0'; n.style.transform='translateX(100%)';
        setTimeout(()=>{ if(n.parentNode) c.removeChild(n); },300);
      },3000);
    }
    function showLoading(show) { document.getElementById('loadingIndicator').classList.toggle('hidden', !show); }
    function stripHtml(html) { if (!html) return ''; const d = document.createElement('div'); d.innerHTML = html; return d.textContent || d.innerText || ''; }
    function extractImageFromContent(content) {
      if (!content) return ''; const m = content.match(/<img[^>]+src=["']([^"']+)["']/i); return m ? m[1] : '';
    }
  </script>
</body>
</html>
